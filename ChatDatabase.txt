CREATE TABLE USERS(
	USER_ID SERIAL,
	USER_NAME VARCHAR(255),
	USER_PASSWORD VARCHAR(255),
	USER_HOTEN VARCHAR(255),
	USER_DIACHI VARCHAR(255),
	USER_NGAYSINH DATE,
	USER_GIOITINH boolean,
	USER_EMAIL varchar(255),
	USER_NGAYTAOTK TIMESTAMP,
	USER_NGAYCUOIDANGNHAP TIMESTAMP,
	USER_KHOA boolean,
	USER_ONLINE boolean,
	USER_LSDANGNHAP TIMESTAMP[],

	PRIMARY KEY(USER_ID)
);

CREATE TABLE FRIENDLIST(
	USER_ID1 INT,
	USER_ID2 INT,

	PRIMARY KEY(USER_ID1, USER_ID2)
);

CREATE TABLE FRIEND_WAITLINE(
	USER_ID1 INT,
	USER_ID2 INT,

	PRIMARY KEY(USER_ID1, USER_ID2)
);

CREATE TABLE DIRECT_CHAT(
	DRCHAT_ID VARCHAR(5),
	USER_ID INT,

	PRIMARY KEY(DRCHAT_ID)
);

CREATE TABLE DIRECT_CHATMESSAGE(
	DRCHAT_ID VARCHAR(5),
	MESSAGE_DATE TIMESTAMP,
	USER_ID INT,
	MESSAGE_INF text,

	PRIMARY KEY(DRCHAT_ID, MESSAGE_DATE, USER_ID)
);

CREATE TABLE GROUP_CHAT(
	GRCHAT_ID VARCHAR(5),
	GROUP_NAME VARCHAR(255),
	PRIMARY KEY(GRCHAT_ID)
);

CREATE TABLE GROUP_MEMBER(
	GRCHAT_ID VARCHAR(5),
	USER_ID INT,
	USER_ADMIN VARCHAR(1),
	
	PRIMARY KEY(GRCHAT_ID, USER_ID)
);

CREATE TABLE GROUP_CHATMESSAGE(
	GRCHAT_ID VARCHAR(5),
	MESSAGE_DATE TIMESTAMP,
	USER_ID INT,
	MESSAGE_INF text,

	PRIMARY KEY(GRCHAT_ID, MESSAGE_DATE, USER_ID)
);

alter table group_chat add group_ngaytao TIMESTAMP;
alter table group_member alter column user_admin type boolean
USING user_admin::boolean;


ALTER TABLE FRIENDLIST
ADD
	CONSTRAINT USER_FRIEND
	FOREIGN KEY(USER_ID1)
	REFERENCES USERS(USER_ID);
ALTER TABLE FRIENDLIST
ADD
	CONSTRAINT FRIENDS
	FOREIGN KEY(USER_ID2)
	REFERENCES USERS(USER_ID);

ALTER TABLE FRIEND_WAITLINE
ADD
	CONSTRAINT FRIEND_IN_WAITLINE1
	FOREIGN KEY(USER_ID1)
	REFERENCES USERS(USER_ID);
ALTER TABLE FRIEND_WAITLINE
ADD
	CONSTRAINT FRIEND_IN_WAITLINE2
	FOREIGN KEY(USER_ID2)
	REFERENCES USERS(USER_ID);

ALTER TABLE DIRECT_CHAT
ADD
	CONSTRAINT USER1
	FOREIGN KEY(USER_ID)
	REFERENCES USERS(USER_ID);

ALTER TABLE DIRECT_CHATMESSAGE
ADD
	CONSTRAINT DRCHATID
	FOREIGN KEY(DRCHAT_ID)
	REFERENCES DIRECT_CHAT(DRCHAT_ID);

ALTER TABLE GROUP_MEMBER
ADD
	CONSTRAINT MEMBER
	FOREIGN KEY(USER_ID)
	REFERENCES USERS(USER_ID);
ALTER TABLE GROUP_MEMBER
ADD
	CONSTRAINT GROUPCHATID
	FOREIGN KEY(GRCHAT_ID)
	REFERENCES GROUP_CHAT(GRCHAT_ID);

ALTER TABLE GROUP_CHATMESSAGE
ADD
	CONSTRAINT GCHATID
	FOREIGN KEY(GRCHAT_ID)
	REFERENCES GROUP_CHAT(GRCHAT_ID);
ALTER TABLE GROUP_CHATMESSAGE
ADD
	CONSTRAINT USERIDF
	FOREIGN KEY(USER_ID)
	REFERENCES USERS(USER_ID);

ALTER TABLE DIRECT_CHATMESSAGE
ADD
	CONSTRAINT USERID_DRCHAT
	FOREIGN KEY(USER_ID)
	REFERENCES USERS(USER_ID);

CREATE TABLE ERASED_DIRECT_CHATMESSAGE(
	DRCHAT_ID VARCHAR(5),
	MESSAGE_DATE TIMESTAMP,
	USER_ID INT,
	MESSAGE_INF text,
	DELETED_USER_ID INT,

	PRIMARY KEY(DRCHAT_ID, MESSAGE_DATE, USER_ID, DELETED_USER_ID)
);

CREATE TABLE ERASED_GROUP_CHATMESSAGE(
	GRCHAT_ID VARCHAR(5),
	MESSAGE_DATE TIMESTAMP,
	USER_ID INT,
	MESSAGE_INF text,
	DELETED_USER_ID INT,
	
	PRIMARY KEY(GRCHAT_ID, MESSAGE_DATE, USER_ID, DELETED_USER_ID)
);
ALTER TABLE ERASED_GROUP_CHATMESSAGE
ADD
	CONSTRAINT ERASED_GROUP_USER
	FOREIGN KEY(DELETED_USER_ID)
	REFERENCES USERS(USER_ID);
	
ALTER TABLE ERASED_GROUP_CHATMESSAGE
ADD
	CONSTRAINT ERASED_GROUPCHATMESSAGE
	FOREIGN KEY(GRCHAT_ID, MESSAGE_DATE, USER_ID)
	REFERENCES GROUP_CHATMESSAGE(GRCHAT_ID, MESSAGE_DATE, USER_ID);
	
ALTER TABLE ERASED_DIRECT_CHATMESSAGE
ADD
	CONSTRAINT ERASED_GROUPCHATMESSAGE
	FOREIGN KEY(DRCHAT_ID, MESSAGE_DATE, USER_ID)
	REFERENCES DIRECT_CHATMESSAGE(DRCHAT_ID, MESSAGE_DATE, USER_ID);
	
ALTER TABLE ERASED_DIRECT_CHATMESSAGE
ADD
	CONSTRAINT ERASED_DIRECT_USER
	FOREIGN KEY(DELETED_USER_ID)
	REFERENCES USERS(USER_ID);

ALTER TABLE direct_chat RENAME COLUMN user_id TO user_id1;
ALTER TABLE direct_chat ADD COLUMN user_id2 int;

create function ChatHistorydr(id1 varchar(5), us_id int )
returns table
(
	dr_id varchar(5), 
	msg_date timestamp, 
	usid int, 
	msg_inf text,
	usname varchar(255)
)
as $$
begin
return query select foo.*,users.user_name from 
(SELECT drchat_id, message_date, user_id, message_inf 
FROM direct_chatmessage 
WHERE drchat_id=id1
except 
SELECT drchat_id, message_date, user_id, message_inf 
FROM erased_direct_chatmessage where deleted_user_id=us_id and drchat_id=id1
) as foo
left join users on foo.user_id = users.user_id
order by message_date asc;
end; $$

LANGUAGE 'plpgsql';

create function getFriendlist(uid int)
returns table(
	us_id int,
	us_name varchar(255),
	us_hoten varchar(255),
	us_ngaysinh date,
	us_email varchar(255),
	us_diachi varchar(255)
)
as $$
begin
return query select users.user_id, users.user_name, users.user_hoten, users.user_ngaysinh, users.user_email, users.user_diachi
from 
(SELECT user_id2 as user_id 
from friendlist 
where user_id1 = uid
UNION
SELECT user_id1 as user_id 
from friendlist 
where user_id2 = 2) as foo
JOIN users on foo.user_id = users.user_id;
end; $$

LANGUAGE 'plpgsql';

create function ChatHistorygr(id1 varchar(5), us_id int )
returns table
(
	dr_id varchar(5), 
	msg_date timestamp, 
	usid int, 
	msg_inf text,
	usname varchar(255)
)
as $$
begin
return query select foo.*,users.user_name from 
(SELECT grchat_id, message_date, user_id, message_inf 
FROM group_chatmessage 
WHERE grchat_id=id1
except 
SELECT grchat_id, message_date, user_id, message_inf 
FROM erased_group_chatmessage where deleted_user_id=us_id and grchat_id=id1
) as foo
left join users on foo.user_id = users.user_id;
end; $$

LANGUAGE 'plpgsql';	

CREATE TABLE users_dangnhap(
	USER_ID INT,
	USER_THOIGIANDANGNHAP TIMESTAMP,
	
	PRIMARY KEY(USER_ID, USER_THOIGIANDANGNHAP)
);

ALTER TABLE users_dangnhap
ADD
	CONSTRAINT USERSDN_USER
	FOREIGN KEY(USER_ID)
	REFERENCES USERS(USER_ID);